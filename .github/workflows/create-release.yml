name: Create Release

on:
  workflow_run:
    workflows: [ "Create Zip Artifact" ]
    types:
      - completed

jobs:
  release:
    runs-on: ubuntu-latest
    permissions: write-all
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for git log history

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.github_token }}" | gh auth login --with-token

      - name: Get release version
        id: get_version
        run: |
          set +e  # disable exit on error temporarily
          RELEASE_DATA=$(gh release list --repo ${{ github.repository }} --limit 5 | grep draft)
          STATUS=$?
          set -e  # enable exit on error again
          
          if [ $STATUS -ne 0 ] || [ -z "$RELEASE_DATA" ]; then
            echo "No draft release found."
            echo "DRAFT_NOT_FOUND=1" >> $GITHUB_ENV
            sudo apt-get install -y jq
            VERSION=$(jq -r .version manifest.json)
          else
            TAG_NAME=$(echo "$RELEASE_DATA" | awk '{print $1}')
            VERSION=$TAG_NAME
            UPLOAD_URL=$(gh release view $TAG_NAME --json upload_url -q .upload_url)
            echo "UPLOAD_URL=$UPLOAD_URL" >> $GITHUB_ENV
          fi
          echo "CURRENT_RELEASE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Generate Release Notes
        id: generate_notes
        run: |
          node ./scripts/generate-release-notes.js

      - name: Create or Update Release
        env:
          GH_TOKEN: ${{ secrets.github_token }}
        run: |
          VERSION="${{ env.CURRENT_RELEASE_VERSION }}"
          # Ensure version has v prefix for tag usage, stripping if double
          CLEAN_VERSION="${VERSION#v}"
          TAG="v$CLEAN_VERSION"
          
          ASSET="./artifacts/Auto_Max_Quality_Pro_v$CLEAN_VERSION.zip"
          NOTES="./RELEASE_NOTES.md"
          
          echo "Processing Release: $TAG"
          echo "Asset Path: $ASSET"
          
          if [ ! -f "$ASSET" ]; then
            echo "Error: Asset not found at $ASSET"
            # Try finding without v prefix in filename if mismatch
            ASSET="./artifacts/Auto_Max_Quality_Pro_$CLEAN_VERSION.zip"
            if [ ! -f "$ASSET" ]; then
               echo "Critical: Could not find asset even at $ASSET"
               exit 1
            fi
          fi

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG exists. Uploading asset..."
            gh release upload "$TAG" "$ASSET" --clobber
          else
            echo "Creating release $TAG..."
            gh release create "$TAG" "$ASSET" --title "Release $TAG" --notes-file "$NOTES" --draft=false --prerelease=false
          fi