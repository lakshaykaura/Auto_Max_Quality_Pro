name: Create Release

on:
    workflow_run:
        workflows: ["Create Zip Artifact"]
        types:
            - completed

jobs:
  release:
    runs-on: ubuntu-20.04
    if: github.event.workflow_run.conclusion == 'success'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install GitHub CLI and Login
      run: |
         sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys C99B11DEB97541F0 23F3D4EA75716059
         sudo apt-add-repository https://cli.github.com/packages
         sudo apt update
         sudo apt install -y gh
         gh auth login --with-token <<< "${{ secrets.github_token }}"

    - name: Get latest draft release info
      id: get_draft
      run: |
        RELEASE_DATA=$(gh release list --repo ${{ github.repository }} --limit 5 | grep draft) # We increased the limit to 5 to have a better chance of getting a draft if available.
        TAG_NAME=$(echo "$RELEASE_DATA" | awk '{print $1}')
        echo "Latest draft release tag: $TAG_NAME"
        echo "RELEASE_TAG=$TAG_NAME" >> $GITHUB_ENV

    - name: Publish the draft release with Artifact from repo
      run: |
         gh release upload ${{ env.RELEASE_TAG }} ./artifacts/YouTube_Max_Quality_Switcher_v${{ env.RELEASE_TAG }}.zip --repo ${{ github.repository }}